code_name: 'LAMMPS'
docker:
  image_name: 'mdi/lammps'

  build_image:
    - apt-get update
    - apt-get install -y git wget vim libblas-dev liblapack-dev nvidia-cuda-toolkit valgrind
    - pip install cmake
    - pip install pymdi
    - pip install mpi4py
    - pip install numpy

  build_engine:
    # Obtain a clone of LAMMPS
    - |
      if [ ! -d "/repo/build/lammps" ]; then
        git clone https://github.com/lammps/lammps.git build/lammps
      fi
    - LAMMPS_INSTALL='mpi'

    # Obtain a clone of the MDI Library
    - cd /repo
    - |
      if [ ! -d "/repo/build/MDI_Library" ]; then
        git clone https://github.com/MolSSI-MDI/MDI_Library.git /repo/build/MDI_Library
      fi
    - rm -rf /repo/build/MDI_Library/build
    - rm -rf /repo/build/MDI_Library/install
    - mkdir -p /repo/build/MDI_Library/build
    - cd /repo/build/MDI_Library/build
    - cmake -D CMAKE_INSTALL_PREFIX=/repo/build/MDI_Library/install ..
    - make -j 1
    - make install
    
    - rm -rf /repo/build/MDI_Library/build2
    - rm -rf /repo/build/MDI_Library/install2
    - mkdir -p /repo/build/MDI_Library/build2
    - cd /repo/build/MDI_Library/build2
    - cmake -Dplugins=ON -Dpython_plugins=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -Dlanguage=C -Dlibtype=STATIC -D CMAKE_INSTALL_PREFIX=/repo/build/MDI_Library/install2 ..
    - make -j 1
    - make install
    

    # Configure LAMMPS
    - cd /repo/build
    - cp /repo/MDI.cmake /repo/build/lammps/cmake/Modules/Packages
    - |
      if [ ! -d "/repo/build/lammps/build" ]; then
        mkdir -p /repo/build/lammps/build
        cd /repo/build/lammps/build
        #cmake -D DOWNLOAD_MDI=off -D mdi_LIBRARY=/repo/build/MDI_Library/install/lib/mdi/libmdi.so -D mdi_INCLUDE_DIR=/repo/build/MDI_Library/install/include/mdi -D PKG_RIGID=yes -D PKG_MOLECULE=yes -D PKG_KSPACE=yes -D PKG_MDI=yes -D BUILD_SHARED_LIBS=yes -D LAMMPS_MACHINE=mpi -DCMAKE_BUILD_TYPE=Debug ../cmake
        #cmake -D DOWNLOAD_MDI=off -D mdi_LIBRARY=/repo/build/MDI_Library/install2/lib/mdi/libmdi.a -D mdi_INCLUDE_DIR=/repo/build/MDI_Library/install2/include/mdi -D PKG_RIGID=yes -D PKG_MOLECULE=yes -D PKG_KSPACE=yes -D PKG_MDI=yes -D BUILD_SHARED_LIBS=yes -D LAMMPS_MACHINE=mpi -DCMAKE_BUILD_TYPE=Debug ../cmake
        cmake -D PKG_RIGID=yes -D PKG_MOLECULE=yes -D PKG_KSPACE=yes -D PKG_MDI=yes -D BUILD_SHARED_LIBS=yes -D LAMMPS_MACHINE=mpi -DCMAKE_BUILD_TYPE=Debug ../cmake
      fi

    # Compile LAMMPS
    - cd /repo/build/lammps/build
    - make -j 4
    - cp lmp_mpi lmp_mdi
    - cp liblammps_mpi.so liblammps.so

    # Build LATTE
    - |
      if [ ! -d "/repo/build/latte" ]; then
        git clone https://github.com/lanl/LATTE.git --branch skimLATTE-progress /repo/build/latte
      fi
    - cd /repo/build/latte
    - cp /repo/makefile.CHOICES.mdi makefile.CHOICES
    - make clean || true
    - make

    # Copy the executables into the example directory
    - cp -r /repo/build/lammps/examples /repo/build/lammps/build/examples
    - cd /repo/build/lammps/build/examples/QM/LATTE
    - cp /repo/build/lammps/build/lmp_mpi .
    - cp /repo/build/latte/LATTE_DOUBLE .

  validate_engine:
    # Confirm that the engine's executable exists
    - ENGINE_EXECUTABLE="build/lammps/build/lmp_mdi"
    - |
      if test -f "$ENGINE_EXECUTABLE"; then
        echo "$ENGINE_EXECUTABLE exists"
      else
        echo "Could not find engine executable: $ENGINE_EXECUTABLE"
        exit 1
      fi

    # Run a test calculation to confirm that the engine can run correctly
    - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/repo/build/lammps/src
    - cd tests/engine_validation
    - ../../${ENGINE_EXECUTABLE} -in lammps.in > lammps.out
    - echo "Test output:"
    - cat lammps.out

    # Run the MDI example calculations
    #- cd ../../
    #- cd build/lammps/examples/USER/mdi
    #- bash -e Script.sh

#  build_engine:
#    # Obtain a clone of LAMMPS
#    - |
#      if [ ! -d "build/lammps" ]; then
#        git clone https://github.com/MolSSI-MDI/lammps.git --branch mdi build/lammps
#      fi
#    - |
#      if [ ! -d "build/lammps/build" ]; then
#        mkdir build/lammps/build
#      fi
#    - cd build/lammps/build
#    - cmake -D PKG_RIGID=yes -D PKG_MOLECULE=yes -D PKG_KSPACE=yes -D PKG_USER-MDI=yes ../cmake
#    - make -j 4

engine_tests:
  script:
    - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/repo/build/lammps/src
    - cd tests/mdi_test
    - ../../build/lammps/build/lmp_mdi -mdi "${MDI_OPTIONS}" -in lammps.in > lammps.out




run_scripts:
  plugin:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - cd tests/plugin
          #- mpiexec -n 1 python3 plugin_driver.py --plugin_name "lammps" --mdi "-role DRIVER -name driver -method LINK -plugin_path /repo/build/lammps/build" --plugin_command_line "foo -in in.series -log log.series"
          - mpiexec -n 1 python3 plugin_driver.py --plugin_name "lammps" --mdi "-role DRIVER -name driver -method LINK -plugin_path /repo/build/lammps/build" --plugin_command_line "-in in.series -log log.series"

  exaalt:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - cd tests/exaalt
          #- mpiexec -n 1 python3 plugin_driver.py --plugin_name "lammps" --mdi "-role DRIVER -name driver -method LINK -plugin_path /repo/build/lammps/build" --plugin_command_line "foo -in in.series -log log.series"
          - mpiexec -n 4 python3 test.py --plugin_name "lammps" --mdi "-role DRIVER -name driver -method LINK -plugin_path /repo/build/lammps/build" --plugin_command_line "-in in.sequence -log log.sequence"


  exaalt2:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - pip uninstall pymdi -y
          - cd /repo/build/MDI_Library/build
          - make install
          - cd /repo/tests/exaalt
          - mpiexec -n 4 python3 test.py --plugin_name "lammps" --mdi "-role DRIVER -name driver -method LINK -plugin_path /repo/build/lammps/build" --plugin_command_line "-in in.sequence -log log.sequence"


  mpifind:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - echo "----------  MPI  ----------"
          - ldd -r /repo/build/lammps/build/lmp_mdi
          - echo ""
          - echo ""
          - echo "--------- MPI4Py ----------"
          - python3 -c "import mpi4py; print(mpi4py.__path__[0])"
          - echo ""
          - echo ""
          - export MPI4PYLOC=$(python3 -c "import mpi4py; print(mpi4py.__path__[0])")
          - ldd -r ${MPI4PYLOC}/*.so


  latte:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/repo/build/MDI_Library/build/MDI_Library
          - cd /repo/build/lammps/build/examples/QM/LATTE
          - mpirun -np 1 ./lmp_mpi -mdi "-name LMP -role DRIVER -method MPI" -in in.aimd.mdi -log log.aimd.mdi.lammps.1 ":" -np 1 ./LATTE_DOUBLE -mdi "-name LATTE -role ENGINE -method MPI"

  latte_plugin:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/repo/build/MDI_Library/build/MDI_Library
          - cd /repo/build/lammps/build/examples/QM/LATTE
          #- valgrind --leak-check=yes --trace-children=yes --track-origins=yes --keep-debuginfo=yes --gen-suppressions=all --suppressions=/repo/valgrind.supp ./lmp_mpi -mdi "-name LMP -role DRIVER -method LINK -plugin_path /repo/build/latte" -in in.aimd.mdi.plugin -log log.aimd.mdi.plugin.lammps.1 2>errors
          - valgrind --leak-check=yes --trace-children=yes --track-origins=yes --keep-debuginfo=yes --gen-suppressions=all ./lmp_mpi -mdi "-name LMP -role DRIVER -method LINK -plugin_path /repo/build/latte" -in in.aimd.mdi.plugin -log log.aimd.mdi.plugin.lammps.1 2>errors

  sequence:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/repo/build/MDI_Library/build/MDI_Library
          - cd /repo/build/lammps/build/examples/QM/LATTE
          - mpirun -np 1 ./lmp_mpi -mdi "-name LMP -role DRIVER -method MPI" -in in.series.mdi -log log.series.mdi.lammps.1 ":" -np 1 ./LATTE_DOUBLE -mdi "-name LATTE -role ENGINE -method MPI"

  sequence2:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/repo/build/MDI_Library/build/MDI_Library
          - cd /repo/build/lammps/build/examples/QM/LATTE
          - mpirun -np 2 ./lmp_mpi -mdi "-name LMP -role DRIVER -method MPI" -in in.series.mdi -log log.series.mdi.lammps.2 ":" -np 1 ./LATTE_DOUBLE -mdi "-name LATTE -role ENGINE -method MPI"

  sequence_plugin:
    containers:
      container1:
        image: 'mdi/lammps'
        script:
          - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/repo/build/MDI_Library/build/MDI_Library
          - cd /repo/build/lammps/build/examples/QM/LATTE
          #- valgrind --leak-check=yes --trace-children=yes --track-origins=yes --keep-debuginfo=yes --gen-suppressions=all --suppressions=/repo/valgrind.supp ./lmp_mpi -mdi "-name LMP -role DRIVER -method LINK -plugin_path /repo/build/latte" -in in.series.mdi.plugin -log log.series.mdi.plugin.1 2>errors
          - valgrind --leak-check=yes --trace-children=yes --track-origins=yes --keep-debuginfo=yes --gen-suppressions=all ./lmp_mpi -mdi "-name LMP -role DRIVER -method LINK -plugin_path /repo/build/latte" -in in.series.mdi.plugin -log log.series.mdi.plugin.1 2>errors
